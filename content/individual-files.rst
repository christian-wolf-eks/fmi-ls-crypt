.. _hashing:

Hashing of individual files
###########################

All cryptographic hashes must be calculated using the SHA-256 or SHA-512 hash algorithms.

All individual files in the zip archive except for the :ref:`cryptographic chain file <crypto-file>` must be individually hashed.

Raw hash mappings as string
===========================

The hashes of the individual files are generated as a simple string.
The hash string must not directly be stored in the FMU.
Instead, an encoded version is defined in :ref:`hashes-in-xml`.

Each line represents a single file.
The line starts with the hash value, two spaces and the relative file name in the ZIP file.
The line termination is a single newline char (``\n``).
Comments, empty lines, or carriage return chars (``\r``) are not allowed in the string.
The string must end in a new line char (``\n``) after the last entry.

.. note::
    This file structure is the same as generated by the ``sha256sum`` [Coreutils]_ command line utility to calculate file hashes.

    .. code-block::

        e30809277c049545ff5d815902324f52a1563ba279fed5a87ca1e01cafc2fa14  modelDescription.xml
        81d63f2cd6bd742859f9b38f7603eb17adb3c8111f4117fa33e96f9460ffc55f  binaries/x86-linux/test.so

.. warning::

    This file structure will break when newline chars are allows as part of a filename.

Thus, the FMU exporter must make sure that no file in the FMU contains newline chars (``\n``) as part of their filenames.
If such filenames exist, the user must be warned and the export should be aborted.

.. _hashes-in-xml:

Encoding in XML
===============

The lines in the raw hash sting have to be stored in XML format to be used in the :ref:`chain file <crypto-file>`.
To do so, the raw data must be base64-encoded (see [RFC4648]_).
It is explicitly allowed to add newlines, spaces and tab characters to the base64-encoded string to generate a nicely formatted XML file.
This is however not required.

.. note:: Example XML snippet

    .. code-block:: XML

        <individual-hashes>
            ZTMwODA5Mjc3YzA0OTU0NWZmNWQ4MTU5MDIzMjRmNTJhMTU2M2JhMjc5ZmVkNWE4N2NhMWUwMWNh
            ZmMyZmExNCAgbW9kZWxEZXNjcmlwdGlvbi54bWwKODFkNjNmMmNkNmJkNzQyODU5ZjliMzhmNzYw
            M2ViMTdhZGIzYzgxMTFmNDExN2ZhMzNlOTZmOTQ2MGZmYzU1ZiAgYmluYXJpZXMveDg2LWxpbnV4
            L3Rlc3Quc28K
        </individual-hashes>

.. _total-hash:

Generation of the total hash
============================

The base64-encoded string as defined in :ref:`hashes-in-xml` must be hashed again to obtain the total hash of the FMU.
This value must be stored into the ``hash`` attribute of the ``total-hash`` XML tag.
To avoid ambiguity, any newlines or whitespace has to be removed from the base64-encoded string prior to hashing.

The hashing must use the SHA512 hash algorithm.

.. note::
    Example of the hashed base64 encoded string

    .. code:: xml

        <total-hash hash="92056bc0560f1eae68ae9e0195985072837e0001b2f18507a20e37e6af19dbbfa14a42656ae25338cfc0e135d950c54c018c052f0d366aeef6ba06ccc45c8f58" />

Checking by the importer
========================

The importer must check the hashes of each file found in the extracted ZIP file.
To do so, the importer must decode the base64-encoded string.
For each file, the importer must guess the underlying hashing algorithm based on the length of the hashes in the raw string.

Any hash collision must be reported to the user.
Additionally, the user should be able to configure the importer such that the import process is aborted before any binary code from the FMU under test is executed.

If there are files in the FMU which are not part of the hash list, the import must be aborted and an error message must be provided.

Similarly, exceeding entries in the hash mapping list (entries for non-existing files in the FMU) must be reported to the user and there should be an option to abort the execution in this case as well.

Additionally, the importer must check the total hash against the base64-encoded hash string as found in the tag ``indicidual-hashes``.
If the total hash as claimed in the FMU's ``hash`` attribute of the ``total-hash`` XML tag does not match the calculated hash from the ``individual-hashes`` tag, the importer must issue an error message to the user.
The user should also be able to configure the importer to stop any further processing of the FMU before any binary code is executed.

